<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CIN√âMA - Collection Prestigieuse</title>
    <link rel="icon" id="favicon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='75' font-size='75'>üé¨</text></svg>" type="image/svg+xml">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=Lato:wght@300;400;700&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Lato', sans-serif;
            background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 50%, #0d1129 100%);
            background-attachment: fixed;
            min-height: 100vh;
            padding: 40px 20px;
            color: #e8e8e8;
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(ellipse at 20% 50%, rgba(212, 175, 55, 0.05) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 80%, rgba(212, 175, 55, 0.03) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 50px;
            animation: fadeInDown 1s ease;
        }

        @keyframes fadeInDown {
            from { opacity: 0; transform: translateY(-40px); }
            to { opacity: 1; transform: translateY(0); }
        }

        header h1 {
            font-family: 'Playfair Display', serif;
            font-size: 5em;
            font-weight: 900;
            color: #d4af37;
            letter-spacing: 4px;
            margin-bottom: 15px;
            text-shadow: 
                0 0 30px rgba(212, 175, 55, 0.3),
                0 2px 10px rgba(0, 0, 0, 0.8);
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        header h1:hover {
            text-shadow: 
                0 0 40px rgba(212, 175, 55, 0.5),
                0 2px 15px rgba(0, 0, 0, 0.9);
            transform: scale(1.02);
        }

        header h1::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            height: 1px;
            background: linear-gradient(90deg, transparent, #d4af37, transparent);
        }

        header p {
            font-size: 1.3em;
            color: #b8956a;
            font-weight: 300;
            letter-spacing: 2px;
            margin-top: 25px;
        }

        .controls {
            background: linear-gradient(135deg, rgba(26, 31, 58, 0.95), rgba(40, 45, 75, 0.95));
            backdrop-filter: blur(20px);
            padding: 25px;
            border-radius: 0px;
            margin-bottom: 40px;
            border: 2px solid rgba(212, 175, 55, 0.2);
            box-shadow: 
                0 20px 60px rgba(0, 0, 0, 0.6),
                inset 0 1px 0 rgba(212, 175, 55, 0.1);
            animation: fadeInUp 1s ease 0.1s backwards;
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(40px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
        }

        label {
            font-weight: 700;
            margin-bottom: 8px;
            color: #d4af37;
            font-size: 0.75em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        input {
            padding: 10px 12px;
            border: 1px solid rgba(212, 175, 55, 0.3);
            border-radius: 4px;
            font-size: 0.9em;
            background: rgba(10, 14, 39, 0.8);
            color: #e8e8e8;
            transition: all 0.3s;
            font-family: 'Lato', sans-serif;
        }

        input::placeholder {
            color: rgba(184, 149, 106, 0.5);
        }

        input:focus {
            outline: none;
            border-color: #d4af37;
            background: rgba(10, 14, 39, 0.95);
            box-shadow: 
                0 0 0 3px rgba(212, 175, 55, 0.15),
                inset 0 0 10px rgba(212, 175, 55, 0.1);
        }

        .button-group {
            display: flex;
            gap: 4px;
            flex-wrap: nowrap;
            align-items: center;
            overflow: visible;
            padding-bottom: 5px;
            width: 100%;
        }

        .button-group::-webkit-scrollbar {
            height: 4px;
        }
        .button-group::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }
        .button-group::-webkit-scrollbar-thumb {
            background: rgba(212, 175, 55, 0.3);
            border-radius: 4px;
        }

        button {
            padding: 10px 8px;
            background: linear-gradient(135deg, #d4af37 0%, #c9a961 100%);
            color: #1a1f3a;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 700;
            font-size: 0.7em;
            letter-spacing: 0.5px;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            text-transform: uppercase;
            white-space: nowrap;
            flex: 1;
            min-width: fit-content;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        button:hover {
            transform: scale(1.02);
            box-shadow: 0 6px 20px rgba(212, 175, 55, 0.3);
            background: linear-gradient(135deg, #e8c547 0%, #d4af37 100%);
            z-index: 2;
        }

        button:active {
            transform: scale(1.01);
        }

        button.secondary {
            background: rgba(212, 175, 55, 0.05);
            color: #d4af37;
            border: 1px solid rgba(212, 175, 55, 0.25);
            box-shadow: none;
        }

        button.secondary:hover {
            background: rgba(212, 175, 55, 0.15);
            border-color: #d4af37;
        }

        .stats {
            background: linear-gradient(135deg, rgba(212, 175, 55, 0.15), rgba(212, 175, 55, 0.08));
            backdrop-filter: blur(20px);
            padding: 25px 30px;
            border-radius: 0px;
            margin-bottom: 40px;
            color: #e8e8e8;
            font-weight: 500;
            border: 1px solid rgba(212, 175, 55, 0.2);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
            animation: fadeInUp 1s ease 0.2s backwards;
            letter-spacing: 0.5px;
        }

        .stats-container {
            display: flex;
            align-items: center;
            gap: 30px;
        }

        .stats-left {
            min-width: 120px;
            font-size: 1.2em;
            font-weight: 700;
            color: #d4af37;
            text-align: center;
        }

        .stats-center {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .progress-bar {
            width: 100%;
            height: 28px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 14px;
            overflow: hidden;
            border: 1px solid rgba(212, 175, 55, 0.3);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #d4af37 0%, #c9a961 100%);
            border-radius: 14px;
            transition: width 0.4s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75em;
            font-weight: 700;
            color: #1a1f3a;
            min-width: 35px;
        }

        .progress-percentage {
            font-size: 0.85em;
            color: #b8956a;
            text-align: center;
        }

        .stats-right {
            min-width: 140px;
            text-align: center;
            font-size: 1.1em;
            font-weight: 700;
            color: #d4af37;
        }

        .films-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 30px;
            animation: fadeInUp 1s ease 0.3s backwards;
            position: relative;
            z-index: 0;
        }

        .film-card {
            background: linear-gradient(135deg, rgba(26, 31, 58, 0.9), rgba(40, 45, 75, 0.9));
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.7);
            transition: all 0.4s cubic-bezier(0.165, 0.84, 0.44, 1);
            display: flex;
            flex-direction: column;
            border: 1px solid rgba(212, 175, 55, 0.15);
            cursor: pointer;
            height: 100%;
            position: relative;
            z-index: 1;
            overflow: visible;
            isolation: isolate;
        }

        .film-card:hover {
            transform: translateY(-8px);
            border-color: rgba(212, 175, 55, 0.5);
            z-index: 3;
        }

        .film-poster {
            width: 100%;
            height: 400px;
            background: linear-gradient(135deg, #2a2f55, #1a1f3a);
            display: flex;
            align-items: center;
            justify-content: center;
            color: rgba(212, 175, 55, 0.2);
            overflow: hidden;
            position: relative;
        }

        .film-poster img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .film-poster span {
            font-size: 2em;
            text-align: center;
            padding: 20px;
            line-height: 1.3;
            font-weight: bold;
        }

        .film-info-section {
            padding: 15px;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            height: auto;
            overflow-y: visible;
        }

        .film-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.15em;
            font-weight: 700;
            color: #d4af37;
            margin-bottom: 10px;
            line-height: 1.2;
        }

        .film-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 12px;
        }

        .info-item {
            padding: 8px 10px;
            background: rgba(212, 175, 55, 0.08);
            border-left: 2px solid #d4af37;
            border-radius: 3px;
        }

        .info-label {
            font-weight: 700;
            color: #d4af37;
            font-size: 0.65em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 2px;
        }

        .info-value {
            color: #e8e8e8;
            font-size: 0.85em;
        }

        .genres {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 12px;
        }

        .genre-tag {
            background: rgba(212, 175, 55, 0.12);
            color: #d4af37;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.7em;
            border: 1px solid rgba(212, 175, 55, 0.25);
            text-transform: uppercase;
            letter-spacing: 0.3px;
            font-weight: 600;
        }

        .awards {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 12px;
        }

        .award-badge {
            background: linear-gradient(135deg, #d4af37 0%, #c9a961 100%);
            color: #1a1f3a;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.7em;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .watched-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
        }

        .watched-checkbox input {
            width: 16px;
            height: 16px;
            cursor: pointer;
            accent-color: #d4af37;
        }

        .watched-checkbox label {
            color: #b8956a;
            cursor: pointer;
            font-size: 0.85em;
            margin: 0;
            font-weight: 600;
            letter-spacing: 0.3px;
        }

        .film-card.watched {
            opacity: 0.6;
        }

        .film-card.watched .film-poster {
            filter: brightness(0.6) saturate(0.3);
        }

        .action-buttons {
    display: flex;
    gap: 8px;
    margin-top: 15px;
    align-items: center;
    justify-content: space-between;
}

.action-buttons button {
    flex: 1; /* Les boutons prennent la m√™me largeur */
    padding: 8px 5px;
}

.edit-btn, .delete-btn {
    max-width: 35px; /* Sauf les boutons d'ic√¥nes qui restent petits */
    flex: 0 0 35px !important;
}

/* Style pour le logo du fournisseur de streaming */
.provider-icon {
    width: 25px;
    height: 25px;
    border-radius: 4px;
    vertical-align: middle;
    margin-right: 5px;
    object-fit: cover;
}

.stream-btn-content {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 5px;
    width: 100%;
}



        .justwatch-btn {
            flex: 1;
            padding: 10px;
            background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 700;
            font-size: 0.75em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(2, 132, 199, 0.3);
        }

        .justwatch-btn:hover {
            transform: scale(1.02);
            box-shadow: 0 8px 20px rgba(2, 132, 199, 0.4);
            background: linear-gradient(135deg, #38bdf8 0%, #0ea5e9 100%);
        }

        .delete-btn {
            padding: 10px;
            background: rgba(212, 175, 55, 0.12);
            color: #d4af37;
            border: 1px solid rgba(212, 175, 55, 0.3);
            border-radius: 4px;
            cursor: pointer;
            font-weight: 700;
            font-size: 0.8em;
            transition: all 0.3s;
            width: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .delete-btn:hover {
            background: rgba(220, 53, 69, 0.3);
            border-color: #dc3545;
            color: #ff6b7a;
        }

        .empty-message {
            text-align: center;
            color: rgba(184, 149, 106, 0.6);
            font-size: 1.3em;
            padding: 100px 20px;
            grid-column: 1 / -1;
            font-weight: 300;
            letter-spacing: 1px;
        }
	/* --- NOUVEAU CSS POUR VIDEO ET RATING --- */
.video-container {
    position: relative;
    padding-bottom: 56.25%; /* Ratio 16:9 */
    height: 0;
    overflow: hidden;
    border-radius: 8px;
    margin-top: 20px;
    background: #000;
    border: 1px solid rgba(212, 175, 55, 0.2);
}

.video-container iframe {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
}

.rating-container {
    display: inline-flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 15px;
    background: rgba(0, 0, 0, 0.3);
    padding: 5px 15px;
    border-radius: 20px;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.stars {
    color: #00e054; /* Le vert iconique de Letterboxd, ou mettez #d4af37 pour l'or */
    font-size: 1.2em;
    letter-spacing: 2px;
}

.rating-value {
    color: #fff;
    font-weight: bold;
    font-size: 0.9em;
}

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 14, 39, 0.9);
            backdrop-filter: blur(8px);
            z-index: 2000;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.4s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        .modal-card {
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            background: #1a1f3a;
            border: 1px solid #d4af37;
            box-shadow: 0 0 50px rgba(212, 175, 55, 0.2);
            border-radius: 4px;
            display: flex;
            overflow: hidden;
            transform: scale(0.9) translateY(20px);
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            position: relative;
        }

        .modal-overlay.active .modal-card {
            transform: scale(1) translateY(0);
        }

        .modal-poster {
            width: 40%;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-poster img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .modal-info {
            width: 60%;
            padding: 40px;
            overflow-y: auto;
            position: relative;
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 20px;
            background: none;
            border: none;
            color: #d4af37;
            font-size: 2em;
            cursor: pointer;
            z-index: 10;
            box-shadow: none;
            width: auto;
            padding: 0;
        }

        .modal-close:hover {
            transform: scale(1.2);
            background: none;
            color: #fff;
            box-shadow: none;
        }

        #dynamic-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
            background: radial-gradient(circle at center,
                rgba(212, 175, 55, 0.05) 0%,
                transparent 70%);
            opacity: 0.5;
            transition: background 0.4s ease, opacity 0.4s ease;
        }

        @media (max-width: 768px) {
            header h1 {
                font-size: 3em;
            }

            .controls {
                padding: 25px;
            }

            .controls-grid {
                grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
                gap: 15px;
            }

            .button-group {
                flex-wrap: wrap;
                flex-direction: column;
            }

            button {
                width: 100%;
            }

            .films-grid {
                grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
                gap: 20px;
            }

            .stats-container {
                flex-direction: column;
                gap: 15px;
            }

            .stats-left,
            .stats-right {
                width: 100%;
            }

            .stats-center {
                width: 100%;
            }

            .modal-card {
                flex-direction: column;
                height: 85vh;
                overflow-y: auto;
            }

            .modal-poster {
                width: 100%;
                height: 300px;
            }

            .modal-info {
                width: 100%;
                padding: 20px;
            }
        }
		/* --- NOUVEAU CSS POUR LE FORMULAIRE --- */
        .form-group { margin-bottom: 15px; text-align: left; }
        .form-group label { display: block; color: #d4af37; margin-bottom: 5px; font-size: 0.9em; }
        .form-group input, .form-group select { 
            width: 100%; padding: 10px; background: #1a1f3a; border: 1px solid #d4af37; 
            color: white; border-radius: 4px; font-family: 'Lato', sans-serif;
        }
        .btn-primary { background: #d4af37; color: #0a0e27; font-weight: bold; cursor: pointer; }
        .btn-success { background: #10b981; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .btn-info { background: #3b82f6; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-weight: bold; margin-left: 10px; }
        .edit-btn { 
            background: none; border: 1px solid rgba(255,255,255,0.3); color: white; 
            width: 30px; height: 30px; border-radius: 50%; cursor: pointer; 
            display: flex; align-items: center; justify-content: center; margin-left: 5px;
        }
        .edit-btn:hover { background: rgba(255,255,255,0.2); }

		.modal {
    display: none; /* Cach√© par d√©faut */
    position: fixed;
    z-index: 1000; /* Tr√®s haut pour passer devant tout */
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.8);
    backdrop-filter: blur(5px);
    align-items: center;
    justify-content: center;
}

.btn-success, .btn-info {
    height: 100%; /* S'assure qu'ils font la m√™me hauteur que les autres */
    margin: 0;   /* Enl√®ve les marges parasites */
    display: flex;
    align-items: center;
    justify-content: center;
    text-transform: uppercase;
    font-size: 0.7em; /* M√™me taille de police que les autres */
    letter-spacing: 0.5px;
}

.modal.active {
    display: flex; /* S'affiche uniquement avec la classe active */
}
    </style>
</head>
<body>

<div id="dynamic-bg"></div>

    <div class="container">
        <header>
            <h1 style="cursor: pointer;" onclick="goHome()">üé¨ CIN√âMA</h1>
            <p>Collection de Films</p>
        </header>
        
        <div class="controls">
            <div class="controls-grid">
                <div class="control-group">
                    <label>Titre</label>
                    <input type="text" id="searchTitle" placeholder="Rechercher...">
                </div>
                <div class="control-group">
                    <label>Ann√©e (De)</label>
                    <input type="number" id="filterYearMin" placeholder="Ex: 2000">
                </div>
                <div class="control-group">
                    <label>Ann√©e (√Ä)</label>
                    <input type="number" id="filterYearMax" placeholder="Ex: 2023">
                </div>
                <div class="control-group">
                    <label>Genre</label>
                    <input type="text" id="filterGenre" placeholder="Ex: Drame">
                </div>
                <div class="control-group">
                    <label>Plateforme</label>
                    <input type="text" id="filterPlatform" placeholder="Ex: Netflix">
                </div>
                <div class="control-group">
                    <label>Dur√©e Max</label>
                    <input type="text" id="filterDuration" placeholder="2:30">
                </div>

            </div>

<div id="progressContainer" style="display: flex; width: 100%; background: rgba(255,255,255,0.1); height: 8px; border-radius: 10px; margin-bottom: 10px; overflow: hidden; border: 1px solid rgba(0,224,84,0.2);">
    <div id="progressBar" style="width: 0%; height: 100%; background: linear-gradient(90deg, #00e054, #00ff73); transition: width 0.3s ease; box-shadow: 0 0 10px #00e054;"></div>
</div>
<div style="display: flex; justify-content: flex-start;">
        <button onclick="syncStreamingServices()" id="syncBtn" class="btn-primary" style="background: #00e054; color: #0a0e27; font-weight: bold; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">
            üîÑ Synchroniser les plateformes
        </button>
    </div>

            <div class="button-group" style="margin-top: 20px;">
                <button onclick="filterFilms()" style="flex: 1.5; background: #d4af37; color: #0a0e27;">üîç Filtrer</button>
                
                <button class="btn-success" onclick="openEditModal(-1)">Ôºã Ajouter</button>
                <button class="btn-info" onclick="exportData()">‚¨á Exporter</button>

                <button class="secondary" onclick="resetFilters()">‚Ü∫ Reset</button>
                <button class="secondary" onclick="sortAlphabetically()">üî§ A-Z</button>
                <button class="secondary" onclick="sortByYear()">üìÖ R√©cent</button>
                <button class="secondary" onclick="getRandomFilm()">üé≤ Al√©atoire</button>
                
                <button class="secondary" id="hideWatchedBtn" onclick="toggleHideWatched()">üëÅÔ∏è Masquer Vus</button>
                <button class="secondary" id="onlyWatchedBtn" onclick="toggleShowOnlyWatched()">‚úÖ Afficher Vus</button>
                
                <button class="secondary" onclick="removeDuplicates()">üóÇÔ∏è Doublons</button>
                
                <button class="secondary" onclick="document.getElementById('fileInput').click()">üìÇ Importer</button>
                <input type="file" id="fileInput" accept=".txt" style="display: none;" onchange="handleFileImport(event)">
            </div>

        </div>        <div class="stats">
            <div class="stats-container">
                <div class="stats-left" id="statsLeft">0 films</div>
                <div class="stats-center">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill" style="width: 0%;">
                        </div>
                    </div>
                    <div class="progress-percentage" id="progressPercentage">0% compl√©t√©</div>
                </div>
                <div class="stats-right" id="statsRight">0/0 vus</div>
            </div>
        </div>
        
        <div id="filmsList" class="films-grid"></div>
    </div>

	<div id="filmModal" class="modal-overlay" onclick="closeModal(event)">
        <div class="modal-card" id="modalCardContent" onclick="event.stopPropagation()">
        </div>
    </div>
		
		<div id="editModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <button class="modal-close" onclick="closeEditModal()">√ó</button>
            <h2 id="modalTitle" style="color: #d4af37; margin-bottom: 20px;">√âditer le film</h2>
            
            <input type="hidden" id="editIndex"> <div class="form-group">
                <label>Titre</label>
                <input type="text" id="editTitle" placeholder="Ex: Inception">
            </div>
            <div class="form-group" style="display: flex; gap: 10px;">
                <div style="flex: 1;">
                    <label>Ann√©e</label>
                    <input type="number" id="editYear" placeholder="2024">
                </div>
                <div style="flex: 1;">
                    <label>Dur√©e</label>
                    <input type="text" id="editDuration" placeholder="2:30">
                </div>
            </div>
            <div class="form-group">
                <label>Genres (s√©par√©s par des virgules)</label>
                <input type="text" id="editGenres" placeholder="Action, Thriller">
            </div>
            <div class="form-group">
                <label>Plateforme</label>
                <input type="text" id="editPlatform" placeholder="Netflix, Cin√©ma...">
            </div>
            <div class="form-group">
                <label>R√©compenses</label>
                <input type="text" id="editAwards" placeholder="Oscar, Palme d'Or...">
            </div>
            <div class="form-group">
                <label>Lien Poster (Optionnel - Laisser vide pour recherche auto)</label>
                <input type="text" id="editPoster" placeholder="http://...">
            </div>

            <button onclick="saveFilmData()" class="btn-primary" style="width: 100%; padding: 12px; border: none; border-radius: 4px; font-size: 1.1em;">üíæ Sauvegarder</button>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const TMDB_API_KEY = 'a8b8177cf88f3604d3df137469205626'; 
        let allFilms = [];
        let hideWatchedMode = false;
        let showOnlyWatchedMode = false;

        // --- FONCTIONS API TMDB ---
        async function fetchTMDbPoster(title, year) {
            try {
                const cleanTitle = title.trim();
                const url = `https://api.themoviedb.org/3/search/movie?api_key=${TMDB_API_KEY}&query=${encodeURIComponent(cleanTitle)}&year=${year}&language=fr-FR`;
                const response = await fetch(url);
                const data = await response.json();

                if (data.results && data.results.length > 0) {
                    const bestMatch = data.results.find(m => m.poster_path) || data.results[0];
                    if (bestMatch.poster_path) {
                        return `https://image.tmdb.org/t/p/w500${bestMatch.poster_path}`;
                    }
                }
            } catch (error) { console.error(`Erreur TMDb:`, error); }
            return null;
        }
// --- NOUVELLES FONCTIONS STREAMING ---

// Cache pour √©viter de refaire les appels API
const providerCache = new Map();

async function updateStreamingButton(title, year, buttonId) {
    const btn = document.getElementById(buttonId);
    if (!btn) return;

    // Retirer le sablier (le texte par d√©faut)
    btn.innerHTML = "..."; 

    const cacheKey = `${title}-${year}`;

    // V√©rifier le cache
    if (providerCache.has(cacheKey)) {
        applyProvidersToButton(btn, providerCache.get(cacheKey));
        return;
    }

    try {
        // 1. Trouver l'ID du film
        const searchUrl = `https://api.themoviedb.org/3/search/movie?api_key=${TMDB_API_KEY}&query=${encodeURIComponent(title)}&year=${year}&language=fr-FR`;
        const searchRes = await fetch(searchUrl);
        const searchData = await searchRes.json();

        if (!searchData.results || searchData.results.length === 0) {
            btn.textContent = "Introuvable";
            return;
        }

        const movieId = searchData.results[0].id;

        // 2. Trouver les fournisseurs FR
        const providerUrl = `https://api.themoviedb.org/3/movie/${movieId}/watch/providers?api_key=${TMDB_API_KEY}`;
        const providerRes = await fetch(providerUrl);
        const providerData = await providerRes.json();
        
        const frData = providerData.results && providerData.results.FR ? providerData.results.FR : null;

        if (frData) {
            // Priorit√© : Abonnement (flatrate) > Gratuit (ads) > Location (rent)
            let providers = frData.flatrate || frData.ads || frData.rent || [];
            
            // On prend les 3 premiers max pour ne pas casser le bouton
            const topProviders = providers.slice(0, 3).map(p => ({
                name: p.provider_name,
                logo: `https://image.tmdb.org/t/p/original${p.logo_path}`
            }));

            const result = {
                link: frData.link, // Lien vers la page JustWatch
                providers: topProviders
            };
            
            providerCache.set(cacheKey, result);
            applyProvidersToButton(btn, result);
        } else {
            btn.textContent = "Aucun stream";
            btn.style.opacity = "0.5";
        }

    } catch (error) {
        console.error("Erreur Streaming:", error);
        btn.textContent = "Erreur";
    }
}


// --- FONCTION DETAILS (TRAILER + NOTE) ---
async function loadExtendedDetails(title, year) {
    const container = document.getElementById('dynamic-movie-details');
    if (!container) return;

    try {
        // 1. Recherche du film pour avoir l'ID
        const searchUrl = `https://api.themoviedb.org/3/search/movie?api_key=${TMDB_API_KEY}&query=${encodeURIComponent(title)}&year=${year}&language=fr-FR`;
        const searchRes = await fetch(searchUrl);
        const searchData = await searchRes.json();

        if (!searchData.results || searchData.results.length === 0) {
            container.innerHTML = "";
            return;
        }

        const movie = searchData.results[0];
        const movieId = movie.id;
        const rating = movie.vote_average; // Note sur 10

        // 2. R√©cup√©rer les vid√©os (Trailers)
        const videoUrl = `https://api.themoviedb.org/3/movie/${movieId}/videos?api_key=${TMDB_API_KEY}&language=fr-FR`; // Essai en FR
        let videoRes = await fetch(videoUrl);
        let videoData = await videoRes.json();
        
        // Si pas de trailer FR, on cherche en anglais
        if (!videoData.results || videoData.results.length === 0) {
            const videoUrlEn = `https://api.themoviedb.org/3/movie/${movieId}/videos?api_key=${TMDB_API_KEY}&language=en-US`;
            videoRes = await fetch(videoUrlEn);
            videoData = await videoRes.json();
        }

        // Trouver le trailer YouTube
        const trailer = videoData.results.find(v => v.site === "YouTube" && (v.type === "Trailer" || v.type === "Teaser"));
        
        // --- CONSTRUCTION HTML ---
        let htmlContent = '';

        // Affichage Note (Style Letterboxd)
        if (rating) {
            const starsCount = Math.round(rating) / 2; // Convertir /10 en /5
            let starsStr = '';
            for (let i = 1; i <= 5; i++) {
                if (i <= starsCount) starsStr += '‚òÖ';
                else if (i - 0.5 <= starsCount) starsStr += '¬Ω'; // Demi-√©toile (optionnel, sinon ‚òÜ)
                else starsStr += '‚òÜ';
            }
            
            htmlContent += `
                <div class="rating-container" title="Note TMDb : ${rating}/10">
                    <span class="stars">${starsStr}</span>
                    <span class="rating-value">${rating.toFixed(1)}</span>
                </div>
            `;
        }

        // Affichage Trailer
        if (trailer) {
            htmlContent += `
                <div class="video-container">
                  <iframe 
    src="https://www.youtube-nocookie.com/embed/${trailer.key}?rel=0&modestbranding=1&showinfo=0" 
    title="Bande annonce" 
    frameborder="0" 
    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
    allowfullscreen
    referrerpolicy="strict-origin-when-cross-origin">
</iframe>
                </div>
            `;
        } else {
            htmlContent += `<div style="margin-top:20px; color:#666; font-size:0.8em; text-align:center;">Aucune bande-annonce trouv√©e</div>`;
        }

        // Injection avec effet fondu
        container.style.opacity = 0;
        container.innerHTML = htmlContent;
        setTimeout(() => { 
            container.style.transition = "opacity 0.5s";
            container.style.opacity = 1; 
        }, 100);

    } catch (e) {
        console.error("Erreur Details:", e);
        container.innerHTML = "";
    }
}

function applyProvidersToButton(btn, data) {
    if (data.providers && data.providers.length > 0) {
        // Cr√©ation du HTML avec plusieurs images
        const iconsHtml = data.providers.map(p => 
            `<img src="${p.logo}" class="provider-icon" title="${p.name}" alt="${p.name}">`
        ).join('');
        
        btn.innerHTML = `<div class="stream-btn-content">${iconsHtml}</div>`;
        
        // Couleur de fond "JustWatch" (jaune/or) ou Netflix (rouge) ? 
        // Gardons votre bleu/cyan actuel ou passons √† un gris neutre pour faire ressortir les logos
        btn.style.background = "rgba(255, 255, 255, 0.1)";
        btn.style.border = "1px solid rgba(255, 255, 255, 0.2)";
    } else {
        btn.textContent = "Voir options";
    }
    
    // Le clic ouvre toujours la page globale JustWatch pour choisir
    btn.onclick = (e) => {
        e.stopPropagation();
        window.open(data.link, '_blank');
    };
}

        function tryTMDbPoster(imgElement, title, year) {
            imgElement.onerror = null; 
            fetchTMDbPoster(title, year).then(posterUrl => {
                if (posterUrl) {
                    imgElement.src = posterUrl;
                    imgElement.style.opacity = '1';
                } else {
                    imgElement.style.display = 'none';
                    const container = imgElement.parentElement;
                    container.innerHTML = `<span style="color: #d4af37; font-weight: bold; font-size: 1.5em; line-height: 1.3; padding: 10px; text-align: center; display: block;">${title}</span>`;
                }
            });
        }

        // --- GESTION DES DONN√âES (Load/Save/Export) ---

        function loadFilmsFromStorage() {
            try {
                const stored = localStorage.getItem('cinema_films');
                if (stored) {
                    allFilms = JSON.parse(stored);
                    allFilms.sort((a, b) => parseInt(b.year) - parseInt(a.year));
                    displayFilms(allFilms);
                    updateStats();
                } else { updateStats(); }
            } catch (error) { allFilms = []; }
        }

        function saveFilmsToStorage() {
            localStorage.setItem('cinema_films', JSON.stringify(allFilms));
        }

        // NOUVEAU : Fonction d'exportation
        function exportData() {
            if (allFilms.length === 0) return alert("Rien √† exporter !");

            // On reconvertit au format TXT original (Tab separated)
            let content = "";
            allFilms.forEach(f => {
                const genreStr = f.genres.join(', ');
                const awardStr = f.awards.join(', '); // Simplification
                // Format: Titre \t Ann√©e \t Dur√©e \t Awards \t Genres \t Plateforme \t PosterURL
                content += `${f.title}\t${f.year}\t${f.duration}\t${awardStr}\t${genreStr}\t${f.platform}\t${f.posterUrl}\n`;
            });

            // Cr√©ation du fichier t√©l√©chargeable
            const blob = new Blob([content], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Cinema_Database_${new Date().toISOString().slice(0,10)}.txt`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        function parseFilmsFromText(text) {
            const lines = text.split('\n').filter(line => line.trim());
            return lines.map(line => {
                const parts = line.split('\t').map(p => p.trim());
                if (parts.length < 2) return null;
                
                const title = parts[0];
                const year = parts[1];
                const duration = parts[2] || '';
                const awardText = parts[3] || '';
                const genreText = parts[4] || '';
                const platform = parts[5] || '';
                const posterUrl = parts[6] || '';
                
                const genres = genreText ? genreText.split(',').map(g => g.trim()).filter(g => g) : [];
                const awards = awardText ? [awardText] : []; 
                
                return { title, year, duration, awards, genres, platform, posterUrl, watched: false };
            }).filter(f => f && f.title);
        }

        // --- NOUVEAU : GESTION √âDITION / AJOUT ---

        function openEditModal(index) {
            const modal = document.getElementById('editModal');
            const titleInput = document.getElementById('editTitle');
            const yearInput = document.getElementById('editYear');
            const durationInput = document.getElementById('editDuration');
            const genresInput = document.getElementById('editGenres');
            const platformInput = document.getElementById('editPlatform');
            const awardsInput = document.getElementById('editAwards');
            const posterInput = document.getElementById('editPoster');
            const indexInput = document.getElementById('editIndex');
            const modalTitle = document.getElementById('modalTitle');

            if (index === -1) {
                // Mode AJOUT
                modalTitle.textContent = "Ajouter un film";
                indexInput.value = -1;
                titleInput.value = '';
                yearInput.value = new Date().getFullYear();
                durationInput.value = '';
                genresInput.value = '';
                platformInput.value = '';
                awardsInput.value = '';
                posterInput.value = '';
            } else {
                // Mode √âDITION
                const film = allFilms[index];
                modalTitle.textContent = "Modifier : " + film.title;
                indexInput.value = index;
                titleInput.value = film.title;
                yearInput.value = film.year;
                durationInput.value = film.duration;
                genresInput.value = film.genres.join(', ');
                platformInput.value = film.platform;
                awardsInput.value = film.awards.join(', ');
                posterInput.value = film.posterUrl;
            }

            modal.classList.add('active');
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.remove('active');
        }

        function saveFilmData() {
            const index = parseInt(document.getElementById('editIndex').value);
            const title = document.getElementById('editTitle').value.trim();
            const year = document.getElementById('editYear').value;
            
            if (!title || !year) return alert("Le titre et l'ann√©e sont obligatoires");

            const newFilmData = {
                title: title,
                year: year,
                duration: document.getElementById('editDuration').value.trim(),
                genres: document.getElementById('editGenres').value.split(',').map(s => s.trim()).filter(s => s),
                platform: document.getElementById('editPlatform').value.trim(),
                awards: document.getElementById('editAwards').value.split(',').map(s => s.trim()).filter(s => s),
                posterUrl: document.getElementById('editPoster').value.trim(),
                watched: index !== -1 ? allFilms[index].watched : false // Garde le statut vu si √©dition
            };

            if (index === -1) {
                // Ajout
                allFilms.push(newFilmData);
                alert(`Film "${title}" ajout√© !`);
            } else {
                // Modification
                allFilms[index] = newFilmData;
            }

            saveFilmsToStorage();
            closeEditModal();
            closeModal(); // Ferme aussi la modale de d√©tails si ouverte
            
            // Si on a appliqu√© des filtres, on r√©initialise pour voir le changement ou on rafraichit
            filterFilms(); 
        }

        // --- AFFICHAGE ---

        function displayFilms(films) {
            const list = document.getElementById('filmsList');
            if (films.length === 0) {
                list.innerHTML = '<div class="empty-message">Aucun film ne correspond √† vos crit√®res</div>';
                return;
            }

            list.innerHTML = films.map((film, index) => {
                const realIndex = allFilms.indexOf(film);
                const bgColor = generateColorFromTitle(film.title);
                
                const isHttp = film.posterUrl && film.posterUrl.toLowerCase().startsWith('http:');
                const hasUrl = film.posterUrl && film.posterUrl.trim().length > 0;
                let imgTag = (hasUrl && !isHttp) 
                    ? `<img src="${film.posterUrl}" alt="${film.title}" style="width: 100%; height: 100%; object-fit: cover;" onerror="tryTMDbPoster(this, '${film.title.replace(/'/g, "\\'")}', '${film.year}')">`
                    : `<img src="" alt="${film.title}" style="width: 100%; height: 100%; object-fit: cover;" onerror="tryTMDbPoster(this, '${film.title.replace(/'/g, "\\'")}', '${film.year}')">`;

                return `
                <div class="film-card ${film.watched ? 'watched' : ''}"
                     onmouseenter="setCinemaHalo(this, '${bgColor[0]}')"
                     onmouseleave="resetCinemaHalo()"
                     onclick="openModal(${realIndex})">
                    <div class="film-poster" style="background: linear-gradient(135deg, ${bgColor[0]}, ${bgColor[1]});">
                        ${imgTag}
                    </div>
                    <div class="film-info-section">
                        <div class="watched-checkbox" onclick="event.stopPropagation()">
                            <input type="checkbox" id="checkbox-${realIndex}" ${film.watched ? 'checked' : ''} onchange="toggleWatched(${realIndex})">
                            <label for="checkbox-${realIndex}">Vu</label>
                        </div>
                        <div class="film-title">${film.title}</div>
                        <div class="film-info">
                            <div class="info-item"><div class="info-label">Ann√©e</div><div class="info-value">${film.year}</div></div>
                            <div class="info-item"><div class="info-label">Dur√©e</div><div class="info-value">${film.duration}</div></div>
                        </div>
                        
                        <div class="action-buttons">
                            <button id="stream-btn-${realIndex}" 
        class="justwatch-btn loading-pulse" 
        onclick="event.stopPropagation(); checkJustWatch('${film.title.replace(/'/g, "\\'")}', ${film.year})">
    ‚è≥
</button>
<img src="" onerror="updateStreamingButton('${film.title.replace(/'/g, "\\'")}', '${film.year}', 'stream-btn-${realIndex}')" style="display:none;">
                            <button onclick="event.stopPropagation(); openEditModal(${realIndex})" class="edit-btn" title="Modifier">‚úé</button>
                            <button onclick="event.stopPropagation(); deleteFilm(${realIndex})" class="delete-btn">‚úï</button>
                        </div>
                    </div>
                </div>
            `;
            }).join('');
        }

  function openModal(index) {
    const film = allFilms[index];
    const modal = document.getElementById('filmModal');
    const content = document.getElementById('modalCardContent');
    const bgColor = generateColorFromTitle(film.title);

    const isHttp = film.posterUrl && film.posterUrl.toLowerCase().startsWith('http:');
    const hasUrl = film.posterUrl && film.posterUrl.trim().length > 0;
    
    // Gestion de l'image
    let posterContent = (hasUrl && !isHttp)
        ? `<img src="${film.posterUrl}" alt="${film.title}" style="width: 100%; height: 100%; object-fit: cover;" onerror="tryTMDbPoster(this, '${film.title.replace(/'/g, "\\'")}', '${film.year}')">`
        : `<img src="" alt="${film.title}" style="width: 100%; height: 100%; object-fit: cover;" onerror="tryTMDbPoster(this, '${film.title.replace(/'/g, "\\'")}', '${film.year}')">`;

    content.innerHTML = `
        <button class="modal-close" onclick="closeModal(event)">√ó</button>
        <div class="modal-poster" style="background: linear-gradient(135deg, ${bgColor[0]}, ${bgColor[1]});">
            ${posterContent}
        </div>
        <div class="modal-info">
            <h2 style="font-family:'Playfair Display', serif; font-size: 2.5em; color: #d4af37; margin-bottom: 5px;">${film.title}</h2>
            
            <div id="dynamic-movie-details" style="min-height: 40px; margin-bottom: 15px;"></div>

            <div style="color: #b8956a; font-size: 1.1em; margin-bottom: 20px;">
                ${film.year} ‚Ä¢ ${film.duration} ${film.platform ? '‚Ä¢ ' + film.platform : ''}
            </div>
            <div style="margin-bottom: 25px;">
                ${film.genres.map(g => `<span class="genre-tag" style="font-size: 0.9em; padding: 6px 12px; margin-right: 8px;">${g}</span>`).join('')}
            </div>
            ${film.awards.length > 0 ? `<div style="margin-bottom: 25px; background: rgba(212, 175, 55, 0.05); padding: 15px; border-radius: 4px;">
                <h3 style="color: #d4af37; font-size: 0.9em; text-transform: uppercase; margin-bottom: 10px;">R√©compenses</h3>
                <div class="awards">${film.awards.map(a => `<span class="award-badge">üèÜ ${a}</span>`).join('')}</div>
            </div>` : ''}
            
            <div style="margin-top: 30px; display: flex; gap: 15px;">
                <button onclick="checkJustWatch('${film.title.replace(/'/g, "\\'")}', ${film.year})" class="justwatch-btn" style="padding: 15px 30px;">üé• Streaming</button>
                
                <button onclick="closeModal(); openEditModal(${index})" class="btn-primary" style="padding: 15px 30px; border:none; border-radius:4px;">‚úé Modifier</button>
            </div>
        </div>
    `;
    
    modal.classList.add('active');
    document.body.style.overflow = 'hidden';

    // APPEL ASYNCHRONE POUR CHARGER LA VIDEO ET LA NOTE
    loadExtendedDetails(film.title, film.year);
}

        function closeModal(event) {
            if (event) event.stopPropagation();
            document.getElementById('filmModal').classList.remove('active');
            document.body.style.overflow = '';
        }

        // --- FILTRES & UTILS (Inchang√© mais inclus pour que tout marche) ---
        function updateStats() {
            const watched = allFilms.filter(f => f.watched).length;
            const total = allFilms.length;
            const percentage = total > 0 ? Math.round((watched / total) * 100) : 0;
            document.getElementById('statsLeft').textContent = total + ' film' + (total > 1 ? 's' : '');
            document.getElementById('progressFill').style.width = percentage + '%';
            document.getElementById('progressPercentage').textContent = percentage + '% compl√©t√©';
            document.getElementById('statsRight').textContent = watched + '/' + total + ' vus';
        }

        function filterFilms() {
            const title = document.getElementById('searchTitle').value.toLowerCase();
            const yearMin = document.getElementById('filterYearMin').value;
            const yearMax = document.getElementById('filterYearMax').value;
            const genre = document.getElementById('filterGenre').value.toLowerCase();
            const platform = document.getElementById('filterPlatform').value.toLowerCase();
            const durationMax = document.getElementById('filterDuration').value.trim();

            let filtered = allFilms.filter(film => {
                const matchTitle = film.title.toLowerCase().includes(title);
                let matchYear = true;
                if (yearMin && parseInt(film.year) < parseInt(yearMin)) matchYear = false;
                if (yearMax && parseInt(film.year) > parseInt(yearMax)) matchYear = false;
                const matchGenre = !genre || film.genres.some(g => g.toLowerCase().includes(genre));
                const matchPlatform = !platform || film.platform.toLowerCase().includes(platform);
                let matchDuration = true;
                if (durationMax) {
                    const maxMinutes = convertToMinutes(durationMax);
                    const filmMinutes = convertToMinutes(film.duration);
                    if (filmMinutes > 0) matchDuration = filmMinutes <= maxMinutes;
                }
                return matchTitle && matchYear && matchGenre && matchPlatform && matchDuration;
            });

            if (hideWatchedMode) filtered = filtered.filter(f => !f.watched);
            if (showOnlyWatchedMode) filtered = filtered.filter(f => f.watched);
            filtered.sort((a, b) => parseInt(b.year) - parseInt(a.year));
            displayFilms(filtered);
            updateStats();
        }

        function resetFilters() {
            document.querySelectorAll('.controls input').forEach(i => i.value = '');
            hideWatchedMode = false;
            showOnlyWatchedMode = false;
            if(document.getElementById('hideWatchedBtn')) {
                document.getElementById('hideWatchedBtn').className = 'secondary';
                document.getElementById('hideWatchedBtn').textContent = 'üëÅÔ∏è Masquer Vus';
            }
            if(document.getElementById('onlyWatchedBtn')) {
                document.getElementById('onlyWatchedBtn').className = 'secondary';
                document.getElementById('onlyWatchedBtn').textContent = '‚úÖ Afficher Vus';
            }
            displayFilms(allFilms);
            updateStats();
        }

        function getRandomFilm() {
            if (allFilms.length === 0) return alert('Aucun film');
            const random = allFilms[Math.floor(Math.random() * allFilms.length)];
            displayFilms([random]);
        }

        function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const newFilms = parseFilmsFromText(e.target.result);
                    let addedCount = 0, updatedCount = 0;
                    newFilms.forEach(newFilm => {
                        const existing = allFilms.find(f => f.title === newFilm.title && f.year === newFilm.year);
                        if (existing) {
                            const wasWatched = existing.watched;
                            Object.assign(existing, newFilm);
                            existing.watched = wasWatched;
                            updatedCount++;
                        } else {
                            allFilms.push(newFilm);
                            addedCount++;
                        }
                    });
                    resetFilters();
                    alert(`Import: ${addedCount} ajout√©s, ${updatedCount} mis √† jour.`);
                    saveFilmsToStorage();
                    document.getElementById('fileInput').value = '';
                } catch (error) { alert('Erreur: ' + error.message); }
            };
            reader.readAsText(file);
        }

        function checkJustWatch(title, year) {
            window.open(`https://www.justwatch.com/fr/recherche?q=${encodeURIComponent(title)}`, '_blank');
        }

        function convertToMinutes(duration) {
            if (!duration) return 0;
            const parts = duration.split(':');
            if (parts.length === 2) return parseInt(parts[0]) * 60 + parseInt(parts[1]);
            return parseInt(duration) || 0;
        }

        function toggleWatched(index) {
            allFilms[index].watched = !allFilms[index].watched;
            saveFilmsToStorage();
            updateStats();
            if (hideWatchedMode || showOnlyWatchedMode) filterFilms();
        }

        function deleteFilm(index) {
            if (confirm(`Supprimer "${allFilms[index].title}" ?`)) {
                allFilms.splice(index, 1);
                saveFilmsToStorage();
                filterFilms();
            }
        }

        function toggleHideWatched() {
            hideWatchedMode = !hideWatchedMode;
            showOnlyWatchedMode = false;
            document.getElementById('hideWatchedBtn').className = hideWatchedMode ? '' : 'secondary';
            document.getElementById('hideWatchedBtn').textContent = hideWatchedMode ? 'üëÅÔ∏è Afficher Tous' : 'üëÅÔ∏è Masquer Vus';
            document.getElementById('onlyWatchedBtn').className = 'secondary';
            filterFilms();
        }

        function toggleShowOnlyWatched() {
            showOnlyWatchedMode = !showOnlyWatchedMode;
            hideWatchedMode = false;
            document.getElementById('onlyWatchedBtn').className = showOnlyWatchedMode ? '' : 'secondary';
            document.getElementById('onlyWatchedBtn').textContent = showOnlyWatchedMode ? '‚úÖ Afficher Tous' : '‚úÖ Afficher Vus';
            document.getElementById('hideWatchedBtn').className = 'secondary';
            filterFilms();
        }

        function removeDuplicates() {
            const seen = new Set();
            const uniqueFilms = [];
            let duplicateCount = 0;
            allFilms.forEach(film => {
                const key = `${film.title}|${film.year}`;
                if (!seen.has(key)) { seen.add(key); uniqueFilms.push(film); }
                else { duplicateCount++; }
            });
            allFilms = uniqueFilms;
            saveFilmsToStorage();
            resetFilters();
            alert(`‚úî ${duplicateCount} doublons supprim√©s.`);
        }

        function sortAlphabetically() {
            allFilms.sort((a, b) => a.title.localeCompare(b.title, 'fr'));
            displayFilms(allFilms);
        }

        function sortByYear() {
            allFilms.sort((a, b) => parseInt(b.year) - parseInt(a.year));
            displayFilms(allFilms);
        }

        function generateColorFromTitle(title) {
            let hash = 0;
            for (let i = 0; i < title.length; i++) hash = title.charCodeAt(i) + ((hash << 5) - hash);
            const colors = [
                ['#3b82f6', '#1e40af'], ['#8b5cf6', '#5b21b6'], ['#ec4899', '#be185d'],
                ['#10b981', '#065f46'], ['#f59e0b', '#92400e'], ['#ef4444', '#7f1d1d'],
                ['#06b6d4', '#0c4a6e'], ['#6366f1', '#312e81'], ['#14b8a6', '#134e4a']
            ];
            return colors[Math.abs(hash) % colors.length];
        }

        function setCinemaHalo(card, color) {
            const bg = document.getElementById('dynamic-bg');
            const rect = card.getBoundingClientRect();
            bg.style.opacity = '1';
            bg.style.background = `radial-gradient(circle at ${rect.left + rect.width / 2}px ${rect.top + rect.height / 2}px, ${color}66 0%, transparent 85%)`;
        }

        function resetCinemaHalo() {
            const bg = document.getElementById('dynamic-bg');
            bg.style.opacity = '0.5';
            bg.style.background = `radial-gradient(circle at center, rgba(212, 175, 55, 0.05) 0%, transparent 70%)`;
        }

        window.addEventListener('DOMContentLoaded', function() {
            loadFilmsFromStorage();
            const inputs = ['searchTitle', 'filterYearMin', 'filterYearMax', 'filterGenre', 'filterPlatform', 'filterDuration'];
            inputs.forEach(id => {
                const el = document.getElementById(id);
                if(el) el.addEventListener('keypress', e => { if (e.key === 'Enter') filterFilms(); });
            });
            document.addEventListener('keydown', function(event) { if (event.key === "Escape") { closeModal(); closeEditModal(); } });
        });


async function syncStreamingServices() {
    const btn = document.getElementById('syncBtn');
    const container = document.getElementById('progressContainer');
    const bar = document.getElementById('progressBar');
    const originalText = "üîÑ Synchroniser les plateformes";
    
    if (!confirm(`Scanner ${allFilms.length} films ?`)) return;

    // Pr√©paration visuelle
    btn.disabled = true;
    btn.style.opacity = "0.7";
    container.style.display = "block"; // On affiche la barre
    bar.style.width = "0%";

    let count = 0;

    try {
        for (let i = 0; i < allFilms.length; i++) {
            let film = allFilms[i];
            
            // Calcul du pourcentage
            const progress = ((i + 1) / allFilms.length) * 100;
            bar.style.width = `${progress}%`;
            btn.innerText = `‚è≥ Scan : ${i + 1} / ${allFilms.length}`;

            try {
                const searchUrl = `https://api.themoviedb.org/3/search/movie?api_key=${TMDB_API_KEY}&query=${encodeURIComponent(film.title)}&year=${film.year}&language=fr-FR`;
                const res = await fetch(searchUrl);
                const data = await res.json();
                
                if (data.results && data.results.length > 0) {
                    const movieId = data.results[0].id;
                    const watchUrl = `https://api.themoviedb.org/3/movie/${movieId}/watch/providers?api_key=${TMDB_API_KEY}`;
                    const wRes = await fetch(watchUrl);
                    const wData = await wRes.json();

                    const providers = wData.results?.FR?.flatrate;
                    if (providers && providers.length > 0) {
                        film.platform = providers[0].provider_name;
                        count++;
                    }
                }
                await new Promise(res => setTimeout(res, 80)); // Pause l√©g√®re
            } catch (err) { console.error(err); }
        }
        
        saveFilmsToStorage();
        renderFilms();
        alert(`Succ√®s ! ${count} films mis √† jour.`);

    } catch (globalError) {
        console.error(globalError);
    } finally {
        // Remise √† z√©ro
        btn.innerText = originalText;
        btn.disabled = false;
        btn.style.opacity = "1";
        // On cache la barre apr√®s 2 secondes pour laisser le temps de voir qu'elle est pleine
        setTimeout(() => { container.style.display = "none"; }, 2000);
    }
}    </script>
